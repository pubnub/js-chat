~/projects/js-chat git:[master]
yarn && source .env && yarn test -i tests/message.test.ts
yarn install v1.22.22
warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
[1/4] 🔍  Resolving packages...
warning Resolution field "webpack@5.88.2" is incompatible with requested version "webpack@5.90.1"
success Already up-to-date.
$ node -e "try { require('husky').install() } catch (e) {if (e.code !== 'MODULE_NOT_FOUND') throw e}"
husky - Git hooks installed
✨  Done in 0.71s.
yarn run v1.22.22
$ yarn workspace @pubnub/chat run test -i tests/message.test.ts
$ jest -i tests/message.test.ts
 FAIL  tests/message.test.ts (148.052 s)
  Send message test
    ✕ should send and receive unicode messages correctly (11957 ms)
    ✓ should send and receive regular text messages correctly (12973 ms)
    ✓ should delete the message (2026 ms)
    ✓ should restore a soft deleted message (2999 ms)
    ✕ should restore a soft deleted message together with its thread (4258 ms)
    ✕ should only log a warning if you try to restore an undeleted message (1409 ms)
    ✕ should throw an error if you try to create a thread on a deleted message (2997 ms)
    ✓ should edit the message (1659 ms)
    ✕ should toggle the message reaction (1415 ms)
    ✕ should pin the message (1581 ms)
    ✕ should unpin the message (1552 ms)
    ✓ should stream message updates and invoke the callback (3211 ms)
    ✕ should render URLs correctly (1066 ms)
    ✕ should add linked text correctly (700 ms)
    ✕ should throw an error for invalid link format (729 ms)
    ✕ should throw an error if adding a link inside another link (718 ms)
    ✕ should remove a linked URL correctly (743 ms)
    ✕ should report a message (1589 ms)
    ✕ should report a message (deprecated) (1507 ms)
    ✕ should send multiple image files along with a text message correctly (4454 ms)
    ✕ should send image file along with a text message correctly (4069 ms)
    ✕ should send pdf file along with a text message correctly (405 ms)
    ✕ should send txt file along with a text message correctly (4048 ms)
    ✕ should send mp4 file along with a text message correctly (7304 ms)
    ✕ should send multiple different types of files along with a text message correctly (1013 ms)
    ✕ should send 3 messages with proper delays and verify rate limiter (2917 ms)
    ✓ should send long messages and validate correct rendering (10096 ms)
    ✓ should fail to send an empty or whitespace-only message (1076 ms)
    ✓ should send and receive messages in various languages correctly (16612 ms)
    ✕ should toggle the message reaction and then delete the message reaction (1648 ms)
    ✕ should be unable to pin multiple messages (1392 ms)
    ✕ should not allow inserting a link inside another link (808 ms)
    ✕ should send quote message in a Thread (4011 ms)
    ✕ should pin the message inside the Thread (3949 ms)
    ✕ should encrypt and decrypt a message (2052 ms)
    ✕ should encrypt and decrypt a file (2076 ms)
    ✕ should still view text messages sent before enabling encryption (1217 ms)
    ✕ should still view files sent before enabling encryption (2016 ms)
    ✕ should be able to decrypt text and file messages sent using a previous encryption key (2470 ms)
    ✕ should send a message with custom body and transform it to TextMessageContent when received (2032 ms)
    ✕ should send a message with custom body and crash if getMessageResponseBody is incorrect (2131 ms)
    ✕ should be able to pass custom edit and delete action names (2746 ms)
    ✕ should work fine even for multiple schemas on different channels (2865 ms)
    ✕ should be able to read live messages with custom payloads as well (2216 ms)
    ✕ should be able to read live encrypted messages with custom payloads (2178 ms)
    ✕ should be able to read historic encrypted messages with custom payloads (2652 ms)
    ○ skipped shouldn't allow to send image file over 5 mb along with a text message

  ● Send message test › should send and receive unicode messages correctly

    expect(received).toContain(expected) // indexOf

    Expected value: "😀"
    Received array: ["Привет", "你好", "こんにちは", "안녕하세요"]

      63 |
      64 |     for (const unicodeMessage of unicodeMessages) {
    > 65 |       expect(messages).toContain(unicodeMessage)
         |                        ^
      66 |     }
      67 |
      68 |     disconnect()

      at Object.toContain (tests/message.test.ts:65:24)

  ● Send message test › should restore a soft deleted message together with its thread

    PubNubException: Failed to soft delete the channel

      at PubNubException_init_$Create$ (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:1083:28)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.$action [as u1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:102:33)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.l1p [as u1u_1] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/util/Standard.kt:90:59)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.l1p [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:62:18)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:30)

    Cause:
    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at PubNubAPIError.toPubNubError (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/errors/pubnub-api-error.js:198:16)
      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:589:32

  ● Send message test › should only log a warning if you try to restore an undeleted message

    PubNubException: This message has not been deleted

      at MessageImpl.PubNubException_init_$Create$ [as j21] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/util/Utils.kt:47:7669)
      at Message_0.j21 [as restore] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/MessageJs.kt:68:24)
      at Object.restore (tests/message.test.ts:209:23)

  ● Send message test › should throw an error if you try to create a thread on a deleted message

    expect(received).toBe(expected) // Object.is equality

    Expected: "You cannot create threads on deleted messages"
    Received: [PubNubException: You cannot create threads on deleted messages.]

      235 |     })
      236 |
    > 237 |     expect(thrownExceptionString).toBe("You cannot create threads on deleted messages")
          |                                   ^
      238 |   })
      239 |
      240 |   test("should edit the message", async () => {

      at Object.toBe (tests/message.test.ts:237:35)

  ● Send message test › should toggle the message reaction

    expect(received).toBeDefined()

    Received: undefined

      269 |     const toggledMessage = await sentMessage.toggleReaction("like")
      270 |
    > 271 |     expect(toggledMessage.actions?.reactions?.like).toBeDefined()
          |                                                     ^
      272 |
      273 |     const likeReaction = toggledMessage.actions?.reactions?.like
      274 |     if (likeReaction) {

      at Object.toBeDefined (tests/message.test.ts:271:53)

  ● Send message test › should pin the message

    expect(received).toBe(expected) // Object.is equality

    Expected: "17295985058233993"
    Received: undefined

      287 |     const pinnedChannel = await channel.pinMessage(messageToPin)
      288 |
    > 289 |     expect(pinnedChannel.custom?.["pinnedMessageTimetoken"]).toBe(messageToPin.timetoken)
          |                                                              ^
      290 |   }, 30000)
      291 |
      292 |   test("should unpin the message", async () => {

      at Object.toBe (tests/message.test.ts:289:62)

  ● Send message test › should unpin the message

    expect(received).toBe(expected) // Object.is equality

    Expected: "17295985074018905"
    Received: undefined

      299 |
      300 |     const pinnedChannel = await channel.pinMessage(messageToPin)
    > 301 |     expect(pinnedChannel.custom?.["pinnedMessageTimetoken"]).toBe(messageToPin.timetoken)
          |                                                              ^
      302 |
      303 |     const unpinnedChannel = await channel.unpinMessage()
      304 |     expect(unpinnedChannel.custom?.["pinnedMessageTimetoken"]).toBeUndefined()

      at Object.toBe (tests/message.test.ts:301:62)

  ● Send message test › should render URLs correctly

    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at PubNubAPIError.toPubNubError (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/errors/pubnub-api-error.js:198:16)
      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:589:32

  ● Send message test › should add linked text correctly

    TypeError: this.o2m_1.t2e is not a function

      at MessageDraft.t2e [as onChange] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/MessageDraftJs.kt:24:22)
      at Object.onChange (tests/message.test.ts:359:18)

  ● Send message test › should throw an error for invalid link format

    TypeError: this.o2m_1.t2e is not a function

      at MessageDraft.t2e [as onChange] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/MessageDraftJs.kt:24:22)
      at Object.onChange (tests/message.test.ts:382:18)

  ● Send message test › should throw an error if adding a link inside another link

    TypeError: this.o2m_1.t2e is not a function

      at MessageDraft.t2e [as onChange] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/MessageDraftJs.kt:24:22)
      at Object.onChange (tests/message.test.ts:400:18)

  ● Send message test › should remove a linked URL correctly

    TypeError: this.o2m_1.t2e is not a function

      at MessageDraft.t2e [as onChange] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/MessageDraftJs.kt:24:22)
      at Object.onChange (tests/message.test.ts:432:18)

  ● Send message test › should report a message

    TypeError: channel.getMessageReportsHistory is not a function

      476 |     await sleep(150) // history calls have around 130ms of cache time
      477 |
    > 478 |     const { events } = await channel.getMessageReportsHistory()
          |                                      ^
      479 |     const reportMessage = events[0]
      480 |
      481 |     expect(reportMessage?.type).toBe("report")

      at Object.getMessageReportsHistory (tests/message.test.ts:478:38)

  ● Send message test › should report a message (deprecated)

    TypeError: reportedMessage.DEPRECATED_report is not a function

      495 |     const history = await channel.getHistory({ count: 1 })
      496 |     const reportedMessage = history.messages[0]
    > 497 |     await reportedMessage.DEPRECATED_report(reportReason)
          |                           ^
      498 |     await sleep(150) // history calls have around 130ms of cache time
      499 |
      500 |     const adminChannel = await chat.getChannel(INTERNAL_ADMIN_CHANNEL)

      at Object.DEPRECATED_report (tests/message.test.ts:497:27)

  ● Send message test › should send multiple image files along with a text message correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      545 |     expect(messages).toContain(textMessage)
      546 |
    > 547 |     expect(filesReceived.length).toBe(3)
          |                                  ^
      548 |
      549 |     expect(filesReceived[0].id).toBeDefined()
      550 |     expect(filesReceived[0].name).toBe("pblogo1.png")

      at Object.toBe (tests/message.test.ts:547:34)

  ● Send message test › should send image file along with a text message correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      592 |     expect(messages).toContain(textMessage)
      593 |
    > 594 |     expect(filesReceived.length).toBe(1)
          |                                  ^
      595 |
      596 |     expect(filesReceived[0].id).toBeDefined()
      597 |     expect(filesReceived[0].name).toBe("pblogo1.png")

      at Object.toBe (tests/message.test.ts:594:34)

  ● Send message test › should send pdf file along with a text message correctly

    PubNubException: Failed to create/update channel data.

      at PubNubException_init_$Create$ (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:1109:28)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.$action [as u1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:102:33)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.l1p [as u1u_1] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/util/Standard.kt:90:59)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.l1p [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:62:18)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:30)

    Cause:
    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at PubNubAPIError.toPubNubError (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/errors/pubnub-api-error.js:198:16)
      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:589:32

  ● Send message test › should send txt file along with a text message correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      666 |     expect(messages).toContain(textMessage)
      667 |
    > 668 |     expect(filesReceived.length).toBe(1)
          |                                  ^
      669 |
      670 |     expect(filesReceived[0].id).toBeDefined()
      671 |     expect(filesReceived[0].name).toBe("sample1.txt")

      at Object.toBe (tests/message.test.ts:668:34)

  ● Send message test › should send mp4 file along with a text message correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      703 |     expect(messages).toContain(textMessage)
      704 |
    > 705 |     expect(filesReceived.length).toBe(1)
          |                                  ^
      706 |
      707 |     expect(filesReceived[0].id).toBeDefined()
      708 |     expect(filesReceived[0].name).toBe("example-video.mp4")

      at Object.toBe (tests/message.test.ts:705:34)

  ● Send message test › should send multiple different types of files along with a text message correctly

    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:1736:27

  ● Send message test › should send 3 messages with proper delays and verify rate limiter

    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at PubNubAPIError.toPubNubError (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/errors/pubnub-api-error.js:198:16)
      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:589:32

  ● Send message test › should toggle the message reaction and then delete the message reaction

    expect(received).toBeDefined()

    Received: undefined

      938 |     const toggledMessage = await sentMessage.toggleReaction("like")
      939 |
    > 940 |     expect(toggledMessage.actions?.reactions?.like).toBeDefined()
          |                                                     ^
      941 |
      942 |     const messageAfterRemovingReaction = await toggledMessage.toggleReaction("like")
      943 |

      at Object.toBeDefined (tests/message.test.ts:940:53)

  ● Send message test › should be unable to pin multiple messages

    PubNubException: Failed to create/update channel data.

      at PubNubException_init_$Create$ (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:1109:28)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.$action [as u1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:102:33)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.l1p [as u1u_1] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/util/Standard.kt:90:59)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.l1p [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:62:18)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:30)

    Cause:
    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at PubNubAPIError.toPubNubError (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/errors/pubnub-api-error.js:198:16)
      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:589:32

  ● Send message test › should not allow inserting a link inside another link

    TypeError: this.o2m_1.t2e is not a function

      at MessageDraft.t2e [as onChange] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/MessageDraftJs.kt:24:22)
      at Object.onChange (tests/message.test.ts:985:18)

  ● Send message test › should send quote message in a Thread

    TypeError: Cannot read properties of null (reading 'text')

      1053 |
      1054 |     expect(forwardedMessageText).toBe("This is a forwarded message.")
    > 1055 |     expect(forwardedMessageQuote.text).toBe("First message")
           |                                  ^
      1056 |     expect(forwardedMessageQuote.userId).toBe("test-user")
      1057 |   })
      1058 |

      at Object.text (tests/message.test.ts:1055:34)

  ● Send message test › should pin the message inside the Thread

    expect(received).toBe(expected) // Object.is equality

    Expected: "17295985806117570"
    Received: undefined

      1083 |     const pinnedThread = await thread.pinMessage(messageToPin)
      1084 |
    > 1085 |     expect(pinnedThread.custom?.["pinnedMessageTimetoken"]).toBe(messageToPin.timetoken)
           |                                                             ^
      1086 |   })
      1087 |
      1088 |   test("should encrypt and decrypt a message", async () => {

      at Object.toBe (tests/message.test.ts:1085:61)

  ● Send message test › should encrypt and decrypt a message

    ReferenceError: crypto is not defined

      at crypto (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/js/src/kotlin/uuid/UuidJs.kt:11:5)
      at Companion_18.secureRandomUuid [as hh] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/uuid/Uuid.kt:372:13)
      at ChatImpl.hh [as c20] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:585:48)
      at Chat_0.c20 [as createGroupConversation] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/ChatJs.kt:216:21)
      at Object.createGroupConversation (tests/message.test.ts:1098:59)

  ● Send message test › should encrypt and decrypt a file

    ReferenceError: crypto is not defined

      at crypto (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/js/src/kotlin/uuid/UuidJs.kt:11:5)
      at Companion_18.secureRandomUuid [as hh] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/uuid/Uuid.kt:372:13)
      at ChatImpl.hh [as c20] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:585:48)
      at Chat_0.c20 [as createGroupConversation] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/ChatJs.kt:216:21)
      at Object.createGroupConversation (tests/message.test.ts:1148:59)

  ● Send message test › should still view text messages sent before enabling encryption

    PubNubException: REST API request processing error, check status for details

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at m1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:21:44)

    Cause:
    PubNubError: REST API request processing error, check status for details

      at PubNubAPIError.toPubNubError (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/errors/pubnub-api-error.js:198:16)
      at ../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/node_modules/pubnub/lib/core/pubnub-common.js:589:32

  ● Send message test › should still view files sent before enabling encryption

    ReferenceError: crypto is not defined

      at crypto (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/js/src/kotlin/uuid/UuidJs.kt:11:5)
      at Companion_18.secureRandomUuid [as hh] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/uuid/Uuid.kt:372:13)
      at ChatImpl.hh [as c20] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:585:48)
      at Chat_0.c20 [as createGroupConversation] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/ChatJs.kt:216:21)
      at Object.createGroupConversation (tests/message.test.ts:1242:46)

  ● Send message test › should be able to decrypt text and file messages sent using a previous encryption key

    ReferenceError: crypto is not defined

      at crypto (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/js/src/kotlin/uuid/UuidJs.kt:11:5)
      at Companion_18.secureRandomUuid [as hh] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/uuid/Uuid.kt:372:13)
      at ChatImpl.hh [as c20] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/ChatImpl.kt:585:48)
      at Chat_0.c20 [as createGroupConversation] (../../pubnub-chat/pubnub-chat-impl/build/src/jsMain/kotlin/ChatJs.kt:216:21)
      at Object.createGroupConversation (tests/message.test.ts:1304:51)

  ● Send message test › should send a message with custom body and transform it to TextMessageContent when received

    PubNubException: Failed to retrieve getHistory data.

      at PubNubException_init_$Create$ (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/channel/BaseChannel.kt:796:32)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.$action [as u1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:102:33)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.l1p [as u1u_1] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/util/Standard.kt:90:59)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.l1p [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:62:18)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

    Cause:
    PubNubException: Cannot read properties of undefined (reading 'body')

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.m1o [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:243:16)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

    Cause:
    TypeError: Cannot read properties of undefined (reading 'body')

      1376 |           getMessageResponseBody: (messageParams: MessageDTOParams) => {
      1377 |             return {
    > 1378 |               text: messageParams.message.body.message.content.text,
           |                                           ^
      1379 |               type: messageParams.message.messageType,
      1380 |               files: messageParams.message.body.files,
      1381 |             }

      at body (tests/message.test.ts:1378:43)
      at $this (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/serialization/encoders.kt:112:26)
      at Companion_8.tmp1_safe_receiver [as j2f] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/message/MessageImpl.kt:49:17)
      at l (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/@pubnub/chat_internal.js:5623:25)
      at $messageFactory (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/channel/BaseChannel.kt:791:25)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.$action [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:234:36)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

  ● Send message test › should send a message with custom body and crash if getMessageResponseBody is incorrect

    expect(received).toBe(expected) // Object.is equality

    Expected: "Cannot read properties of undefined (reading 'does')"
    Received: "Failed to retrieve getHistory data."

      1426 |     }
      1427 |
    > 1428 |     expect(thrownErrorMessage).toBe("Cannot read properties of undefined (reading 'does')")
           |                                ^
      1429 |   })
      1430 |
      1431 |   test("should be able to pass custom edit and delete action names", async () => {

      at Object.toBe (tests/message.test.ts:1428:32)

  ● Send message test › should be able to pass custom edit and delete action names

    expect(received).toBe(expected) // Object.is equality

    Expected: "Edited text"
    Received: "Hello world!"

      1450 |     await sleep(200)
      1451 |     historyObject = await someChannel.getHistory({ count: 1 })
    > 1452 |     expect(historyObject.messages[0].text).toBe("Edited text")
           |                                            ^
      1453 |     expect(historyObject.messages[0].actions["field-updated"]).toBeDefined()
      1454 |     expect(historyObject.messages[0].actions[defaultEditActionName]).toBeUndefined()
      1455 |     expect(historyObject.messages[0].deleted).toBe(false)

      at Object.toBe (tests/message.test.ts:1452:44)

  ● Send message test › should work fine even for multiple schemas on different channels

    PubNubException: Failed to retrieve getHistory data.

      at PubNubException_init_$Create$ (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/channel/BaseChannel.kt:796:32)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.$action [as u1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:102:33)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.l1p [as u1u_1] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/util/Standard.kt:90:59)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.l1p [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:62:18)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

    Cause:
    PubNubException: Cannot read properties of undefined (reading 'body')

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.m1o [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:243:16)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

    Cause:
    TypeError: Cannot read properties of undefined (reading 'body')

      1506 |
      1507 |             return {
    > 1508 |               text: messageParams.message.body.message.content.text,
           |                                           ^
      1509 |               type: messageParams.message.messageType,
      1510 |               files: messageParams.message.body.files,
      1511 |             }

      at body (tests/message.test.ts:1508:43)
      at $this (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/serialization/encoders.kt:112:26)
      at Companion_8.tmp1_safe_receiver [as j2f] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/message/MessageImpl.kt:49:17)
      at l (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/@pubnub/chat_internal.js:5623:25)
      at $messageFactory (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/channel/BaseChannel.kt:791:25)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.$action [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:234:36)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

  ● Send message test › should be able to read live messages with custom payloads as well

    expect(received).toBe(expected) // Object.is equality

    Expected: "Hello live world!"
    Received: ""

      1581 |     await someChannel.sendText("Hello live world!")
      1582 |     await sleep(500)
    > 1583 |     expect(liveMessageText).toBe("Hello live world!")
           |                             ^
      1584 |     await someChannel.sendText("Hello live world! Number 2")
      1585 |     await sleep(500)
      1586 |     expect(liveMessageText).toBe("Hello live world! Number 2")

      at Object.toBe (tests/message.test.ts:1583:29)

  ● Send message test › should be able to read live encrypted messages with custom payloads

    expect(received).toBe(expected) // Object.is equality

    Expected: "Hello encrypted world!"
    Received: ""

      1630 |     await someChannel.sendText("Hello encrypted world!")
      1631 |     await sleep(500)
    > 1632 |     expect(liveMessageText).toBe("Hello encrypted world!")
           |                             ^
      1633 |     await someChannel.sendText("Hello encrypted world! Number 2")
      1634 |     await sleep(500)
      1635 |     expect(liveMessageText).toBe("Hello encrypted world! Number 2")

      at Object.toBe (tests/message.test.ts:1632:29)

  ● Send message test › should be able to read historic encrypted messages with custom payloads

    PubNubException: Failed to retrieve getHistory data.

      at PubNubException_init_$Create$ (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/channel/BaseChannel.kt:796:32)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.$action [as u1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:102:33)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.l1p [as u1u_1] (../../pubnub-chat-impl/build/compileSync/js/main/productionLibrary/kotlin/src/kotlin/util/Standard.kt:90:59)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_2.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1785:17)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.l1p [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/commonMain/kotlin/com/pubnub/kmp/futures.kt:62:18)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

    Cause:
    PubNubException: Cannot read properties of undefined (reading 'body')

      at Companion_5.protoOf.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/jsMain/kotlin/com/pubnub/api/PubNubException.kt:29:17)
      at Companion_3.n1o (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:115:108)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.m1o [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:243:16)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

    Cause:
    TypeError: Cannot read properties of undefined (reading 'body')

      1657 |           getMessageResponseBody: (messageParams: MessageDTOParams) => {
      1658 |             return {
    > 1659 |               text: messageParams.message.body.message.content.text,
           |                                           ^
      1660 |               type: messageParams.message.messageType,
      1661 |               files: messageParams.message.body.files,
      1662 |             }

      at body (tests/message.test.ts:1659:43)
      at $this (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/serialization/encoders.kt:112:26)
      at Companion_8.tmp1_safe_receiver [as j2f] (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/message/MessageImpl.kt:49:17)
      at l (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/@pubnub/chat_internal.js:5623:25)
      at $messageFactory (../../pubnub-chat/pubnub-chat-impl/build/src/commonMain/kotlin/com/pubnub/chat/internal/channel/BaseChannel.kt:791:25)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.$action [as s1u_1] (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-core-api/src/commonMain/kotlin/com/pubnub/api/v2/callbacks/Result.kt:234:36)
      at sam$com_pubnub_api_v2_callbacks_Consumer$0_0.protoOf.l1p (../../pubnub-chat/pubnub-chat-impl/build/dist/js/productionLibrary/pubnub-pubnub-kotlin-pubnub-kotlin-api.js:1608:17)
      at l1p (../../pubnub-kotlin/pubnub-kotlin/pubnub-kotlin-api/src/jsMain/kotlin/com/pubnub/api/EndpointImpl.kt:15:34)

Test Suites: 1 failed, 1 total
Tests:       38 failed, 1 skipped, 8 passed, 47 total
Snapshots:   0 total
Time:        148.103 s
Ran all test suites matching /tests\/message.test.ts/i.
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
error Command failed.
Exit code: 1
Command: /opt/homebrew/Cellar/node@18/18.20.4_1/bin/node
Arguments: /opt/homebrew/lib/node_modules/yarn/lib/cli.js run test -i tests/message.test.ts
Directory: /Users/wojciech.kalicinski/projects/js-chat/lib
Output:

info Visit https://yarnpkg.com/en/docs/cli/workspace for documentation about this command.
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.

